<!DOCTYPE html>
<html lang="ne">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>आम्दानीको स्रोत प्रमाणिकरण पत्र</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 5px;
        }
        .container {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            padding: 15px;
            width: 100%;
            max-width: 800px;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .form-section, .preview-section {
            display: none;
        }
        .form-section.active {
            display: block;
        }
        .preview-section.active {
            display: block;
        }

        /* A4 size for printing */
        @media print {
            body {
                background: none;
                margin: 0;
                padding: 0;
            }
            .container {
                box-shadow: none;
                border-radius: 0;
                width: 210mm;
                min-height: 297mm;
                margin: 0 auto;
                padding: 10mm;
                page-break-after: always;
                position: relative;
            }
            .form-section, .buttons-container {
                display: none !important;
            }
            .preview-section {
                display: block !important;
                position: relative;
            }
            .letter-content {
                position: relative;
                z-index: 10;
            }
            .watermark {
                display: block !important;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80%;
                height: auto;
                opacity: 0.08 !important;
                pointer-events: none;
                z-index: 1;
            }
            .dotted-line-bottom {
                border-bottom: 1px dotted #999 !important;
                text-align: initial !important;
            }
            .field-value {
                white-space: normal !important;
                overflow: visible !important;
                text-overflow: clip !important;
            }
            .header-left-align {
                text-align: left !important;
            }
            .header-right-align {
                text-align: right !important;
            }
            .no-wrap {
                white-space: nowrap;
            }
        }

        /* Watermark styling */
        .watermark-container {
            position: relative;
            min-height: 500px;
        }
        .watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: auto;
            opacity: 0.08;
            pointer-events: none;
            z-index: 1;
        }
        .letter-content {
            position: relative;
            z-index: 10;
        }
        /* Custom styles for dotted lines and layout */
        .dotted-line-bottom {
            border-bottom: 1px dotted #999;
            padding-bottom: 2px;
            display: inline-block;
            text-align: left;
            box-sizing: border-box;
            margin-left: 1px;
            margin-right: 1px;
            flex-grow: 1;
            flex-shrink: 1;
            white-space: nowrap; /* Prevents values from wrapping */
        }
        .field-row {
            display: flex;
            align-items: baseline;
            margin-bottom: 8px;
            flex-wrap: wrap;
        }
        .field-label {
            flex-shrink: 0;
            margin-right: 5px;
            white-space: nowrap;
        }
        .field-value {
            flex-grow: 1;
            white-space: normal;
        }
        .header-top-right p {
            margin-bottom: 2px;
        }
        .header-center p {
            margin-bottom: 2px;
        }
        .header-left-align {
            text-align: left;
        }
        .header-right-align {
            text-align: right;
        }
        .header-flex-item {
            flex-basis: 33.33%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header-flex-item.left {
            align-items: flex-start;
        }
        .header-flex-item.right {
            align-items: flex-end;
        }
        .header-main-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
        }
        .header-bottom-left {
            text-align: left;
            width: 50%;
        }
        .header-bottom-right {
            text-align: right;
            width: 50%;
        }
        .header-top-section {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            margin-bottom: 10px;
        }
        .header-top-section .left-col {
            flex-basis: 20%;
            text-align: left;
        }
        .header-top-section .center-col {
            flex-basis: 60%;
            text-align: center;
        }
        .header-top-section .right-col {
            flex-basis: 20%;
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: flex-end;
        }
        .header-top-section .right-col p {
            margin-bottom: 2px;
        }
        .header-center p {
            white-space: normal;
            word-break: break-word;
            font-size: 0.875rem;
            line-height: 1.25rem;
        }
        .header-center p.text-lg {
            font-size: 1.125rem;
            line-height: 1.75rem;
        }
        .header-flex-item.left, .header-flex-item.right {
            flex-basis: 15%;
            max-width: 15%;
        }
        .header-flex-item.center {
            flex-basis: 70%;
            max-width: 70%;
        }
        .dotted-table {
            border-collapse: collapse;
            width: 100%;
        }
        .dotted-table th, .dotted-table td {
            border: 1px dotted #999;
            padding: 8px;
            text-align: left;
        }
        .dotted-table th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="formSection" class="form-section active">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">आम्दानीको स्रोत प्रमाणिकरण विवरण प्रविष्ट गर्नुहोस्</h2>
            <form id="letterForm" class="space-y-6">
                <div>
                    <label for="municipalityNepali" class="block text-sm font-medium text-gray-700">नगरपालिका (नेपाली):</label>
                    <input type="text" id="municipalityNepali" name="municipalityNepali" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="नगरपालिका नेपालीमा प्रविष्ट गर्नुहोस्">
                </div>
                <div>
                    <label for="wardOfficeNepali" class="block text-sm font-medium text-gray-700">वडा कार्यालय (नेपाली):</label>
                    <input type="text" id="wardOfficeNepali" name="wardOfficeNepali" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="वडा कार्यालय नेपालीमा प्रविष्ट गर्नुहोस्">
                </div>
                <div>
                    <label for="districtNepali" class="block text-sm font-medium text-gray-700">जिल्ला (नेपाली):</label>
                    <input type="text" id="districtNepali" name="districtNepali" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="जिल्ला नेपालीमा प्रविष्ट गर्नुहोस्">
                </div>
                <div>
                    <label for="provinceNepali" class="block text-sm font-medium text-gray-700">प्रदेश (नेपाली):</label>
                    <input type="text" id="provinceNepali" name="provinceNepali" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="प्रदेश नेपालीमा प्रविष्ट गर्नुहोस्">
                </div>
                <div>
                    <label for="municipalityEnglish" class="block text-sm font-medium text-gray-700">Municipality (English):</label>
                    <input type="text" id="municipalityEnglish" name="municipalityEnglish" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Municipality name in English">
                </div>
                <div>
                    <label for="wardOfficeEnglish" class="block text-sm font-medium text-gray-700">Ward Office (English):</label>
                    <input type="text" id="wardOfficeEnglish" name="wardOfficeEnglish" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Ward Office name in English">
                </div>
                <div>
                    <label for="districtEnglish" class="block text-sm font-medium text-gray-700">District (English):</label>
                    <input type="text" id="districtEnglish" name="districtEnglish" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="District name in English">
                </div>
                <div>
                    <label for="provinceEnglish" class="block text-sm font-medium text-gray-700">Province (English):</label>
                    <input type="text" id="provinceEnglish" name="provinceEnglish" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Province name in English">
                </div>
                <div>
                    <label for="refNo" class="block text-sm font-medium text-gray-700">चलानी नं. (Des. No.):</label>
                    <input type="text" id="refNo" name="refNo" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="चलानी नं. प्रविष्ट गर्नुहोस्">
                </div>
                <div>
                    <label for="date" class="block text-sm font-medium text-gray-700">मिति (Date):</label>
                    <input type="text" id="date" name="date" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="dd/mm/yyyy (वि.सं.)">
                </div>
                <div>
                    <label for="applicantName" class="block text-sm font-medium text-gray-700">श्रीमती/श्री (नेपाली):</label>
                    <input type="text" id="applicantName" name="applicantName" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="निवेदन दिने व्यक्तिको नाम नेपालीमा प्रविष्ट गर्नुहोस्">
                </div>
                <div>
                    <label for="forWhom" class="block text-sm font-medium text-gray-700">कसको लागि प्रमाणित गरिने हो (नेपाली):</label>
                    <input type="text" id="forWhom" name="forWhom" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="प्रमाणित गरिने व्यक्तिको नाम नेपालीमा प्रविष्ट गर्नुहोस्">
                </div>
                <div>
                    <label for="purpose" class="block text-sm font-medium text-gray-700">उद्देश्य (Purpose):</label>
                    <input type="text" id="purpose" name="purpose" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="प्रमाणिकरणको उद्देश्य लेख्नुहोस् (उदा. भिषाको लागि)">
                </div>
                
                <h3 class="text-xl font-bold mt-8">पारिवारिक आम्दानीको स्रोत</h3>
                <div id="incomeSourcesContainer" class="space-y-4">
                    <div class="income-source-row p-4 border rounded-md bg-gray-50 flex items-end space-x-2">
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">आम्दानीको स्रोत</label>
                            <input type="text" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="स्रोत">
                        </div>
                        <div class="flex-grow">
                            <label class="block text-sm font-medium text-gray-700">वार्षिक आम्दानी</label>
                            <input type="number" class="mt-1 block w-full px-3 py-2 border rounded-md" placeholder="नेपाली रुपैयाँमा">
                        </div>
                        <button type="button" class="remove-row-btn px-4 py-2 border rounded-md text-white bg-red-500 hover:bg-red-600">हटाउनुहोस्</button>
                    </div>
                </div>
                <button type="button" id="addSourceBtn" class="px-4 py-2 border rounded-md text-white bg-blue-600 hover:bg-blue-700">नयाँ स्रोत थप्नुहोस्</button>

                <div>
                    <label for="totalIncome" class="block text-sm font-medium text-gray-700">जम्मा वार्षिक आम्दानी:</label>
                    <input type="text" id="totalIncome" name="totalIncome" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="यो स्वत: गणना हुनेछ" readonly>
                </div>
                
                <div>
                    <label for="conversionRate" class="block text-sm font-medium text-gray-700">परिवर्तन दर (1 AUD = NPR):</label>
                    <input type="number" id="conversionRate" name="conversionRate" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="विनिमय दर प्रविष्ट गर्नुहोस्">
                </div>
                
                <div>
                    <label for="totalInAUD" class="block text-sm font-medium text-gray-700">जम्मा वार्षिक आम्दानी (AUD मा):</label>
                    <input type="text" id="totalInAUD" name="totalInAUD" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="यो स्वत: गणना हुनेछ" readonly>
                </div>

                <div>
                    <label for="wardChairpersonName" class="block text-sm font-medium text-gray-700">वडा अध्यक्षको नाम:</label>
                    <input type="text" id="wardChairpersonName" name="wardChairpersonName" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="वडा अध्यक्षको नाम प्रविष्ट गर्नुहोस्">
                </div>

                <div class="buttons-container mt-8 flex justify-center space-x-4">
                    <button type="button" id="previewBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        Preview
                    </button>
                    <button type="button" id="backToFormBtn" class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" style="display: none;">
                        Back to Form
                    </button>
                    <button type="button" id="printBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" style="display: none;">
                        Print
                    </button>
                </div>
            </form>
        </div>

        <div id="previewSection" class="preview-section">
            <div class="watermark-container">
                <img src="https://galkotmun.gov.np/sites/galkotmun.gov.np/files/logo_0.png" alt="Watermark" class="watermark" />
                <div class="letter-content text-sm leading-6">
                    <div class="header-top-section">
                        <div class="left-col flex flex-col items-start">
                            <img src="https://galkotmun.gov.np/sites/galkotmun.gov.np/files/logo_0.png" alt="Logo" class="w-16 h-auto mb-2" />
                        </div>
                        <div class="center-col text-center">
                            <p class="font-bold text-lg" id="previewMunicipalityNepali"></p>
                            <p class="font-bold text-lg" id="previewMunicipalityEnglish"></p>
                            <p class="font-bold text-lg" id="previewWardOfficeNepali"></p>
                            <p class="font-bold text-lg" id="previewWardOfficeEnglish"></p>
                            <p id="previewDistrictProvinceNepali"></p>
                            <p id="previewDistrictProvinceEnglish"></p>
                            <p>नेपाल</p>
                            <p>Nepal</p>
                        </div>
                        <div class="right-col text-right">
                            <p>Website: <span class="dotted-line-bottom">galkotmun.gov.np</span></p>
                            <p>Email: <span class="dotted-line-bottom">galkot8k@gmail.com</span></p>
                            <p>Phone No.: <span class="dotted-line-bottom">+९७७-९८५७६२१११४</span></p>
                        </div>
                    </div>

                    <div class="flex justify-between mt-4">
                        <p class="header-left-align">
                            <span id="previewRefNo"></span>
                        </p>
                        <p class="header-right-align">
                            मिति: <span class="dotted-line-bottom no-wrap" id="previewDate"></span>
                        </p>
                    </div>
                    <div class="text-center mt-4">
                        <p class="font-bold text-xl">
                            विषय: आम्दानीको स्रोत प्रमाणिकरण।
                        </p>
                    </div>
                    <div class="text-center mt-2">
                        <p class="font-bold text-lg">
                            TO WHOM IT MAY CONCERN
                        </p>
                    </div>

                    <div class="mt-8">
                        <p>
                            प्रस्तुत विषयमा, श्री <span class="dotted-line-bottom no-wrap" id="previewApplicantName"></span> ले यस वडा कार्यालयमा पेश गर्नुभएको निवेदन अनुसार निजको छोरी/छोरा <span class="dotted-line-bottom no-wrap" id="previewForWhom"></span> को <span class="dotted-line-bottom no-wrap" id="previewPurpose"></span> को लागि निजको परिवारको वार्षिक आम्दानीको स्रोत र वार्षिक आम्दानी रकमको विवरण प्रमाणित गरी पाउँ भनि सिफारिसको लागि अनुरोध गर्नु भएकोमा देहाय बमोजिमको विवरण प्रमाणित गरिएको छ।
                        </p>
                    </div>

                    <div class="mt-8">
                        <table class="dotted-table">
                            <thead>
                                <tr>
                                    <th>क्र.सं.</th>
                                    <th>आम्दानीको स्रोत</th>
                                    <th>वार्षिक आम्दानी (ने.रु.)</th>
                                </tr>
                            </thead>
                            <tbody id="incomeTableBody">
                                </tbody>
                        </table>
                    </div>

                    <div class="mt-8">
                        <p class="text-right">
                            जम्मा वार्षिक आम्दानी: ने.रु. <span class="dotted-line-bottom" id="previewTotalIncome"></span>
                        </p>
                        <p class="text-right mt-2">
                            (अक्षरुपि: <span class="dotted-line-bottom" id="previewTotalIncomeWords"></span>)
                        </p>
                    </div>
                    
                    <div class="mt-4">
                        <p>
                            यस परिवारको माथि उल्लेखित जम्मा वार्षिक आम्दानी अमेरिकी डलर <span class="dotted-line-bottom" id="previewTotalInAUD"></span> बराबर हुन्छ।
                        </p>
                    </div>
                    
                    <div class="mt-10 text-right">
                        <p class="font-bold" id="previewWardChairpersonName"></p>
                        <p>वडा अध्यक्ष</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="buttons-container mt-8 flex justify-center space-x-4">
            <button type="button" id="previewBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                Preview
            </button>
            <button type="button" id="backToFormBtn" class="px-6 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500" style="display: none;">
                Back to Form
            </button>
            <button type="button" id="printBtn" class="px-6 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500" style="display: none;">
                Print
            </button>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const formSection = document.getElementById('formSection');
            const previewSection = document.getElementById('previewSection');
            const previewBtn = document.getElementById('previewBtn');
            const backToFormBtn = document.getElementById('backToFormBtn');
            const printBtn = document.getElementById('printBtn');
            const addSourceBtn = document.getElementById('addSourceBtn');
            const incomeSourcesContainer = document.getElementById('incomeSourcesContainer');
            const totalIncomeInput = document.getElementById('totalIncome');
            const totalInAUDInput = document.getElementById('totalInAUD');
            const conversionRateInput = document.getElementById('conversionRate');

            // Function to add a new income source row
            function addIncomeSourceRow() {
                const newRow = document.createElement('div');
                newRow.classList.add('income-source-row', 'p-4', 'border', 'rounded-md', 'bg-gray-50', 'flex', 'items-end', 'space-x-2');
                newRow.innerHTML = `
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">आम्दानीको स्रोत</label>
                        <input type="text" class="mt-1 block w-full px-3 py-2 border rounded-md source-input" placeholder="स्रोत">
                    </div>
                    <div class="flex-grow">
                        <label class="block text-sm font-medium text-gray-700">वार्षिक आम्दानी</label>
                        <input type="number" class="mt-1 block w-full px-3 py-2 border rounded-md amount-input" placeholder="नेपाली रुपैयाँमा">
                    </div>
                    <button type="button" class="remove-row-btn px-4 py-2 border rounded-md text-white bg-red-500 hover:bg-red-600">हटाउनुहोस्</button>
                `;
                incomeSourcesContainer.appendChild(newRow);
                newRow.querySelector('.remove-row-btn').addEventListener('click', function() {
                    newRow.remove();
                    calculateTotalIncome();
                });
                newRow.querySelector('.amount-input').addEventListener('input', calculateTotalIncome);
            }
            
            // Function to calculate total income
            function calculateTotalIncome() {
                let total = 0;
                document.querySelectorAll('.amount-input').forEach(input => {
                    total += parseFloat(input.value) || 0;
                });
                totalIncomeInput.value = total.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                updateAUDTotal();
            }

            // Function to update AUD total
            function updateAUDTotal() {
                const totalNPR = parseFloat(totalIncomeInput.value.replace(/,/g, '')) || 0;
                const conversionRate = parseFloat(conversionRateInput.value) || 0;
                if (conversionRate > 0) {
                    const totalAUD = totalNPR / conversionRate;
                    totalInAUDInput.value = totalAUD.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                } else {
                    totalInAUDInput.value = 'N/A';
                }
            }

            // Function to convert number to Nepali words
            function numberToNepaliWords(num) {
                const units = ['', 'एक', 'दुई', 'तीन', 'चार', 'पाँच', 'छ', 'सात', 'आठ', 'नौ'];
                const tens = ['', 'दश', 'बीस', 'तीस', 'चालीस', 'पचास', 'साठी', 'सत्तरी', 'असी', 'नब्बे'];
                const bigUnits = ['', 'सय', 'हजार', 'लाख', 'करोड', 'अर्ब'];

                function convertChunk(n) {
                    let s = '';
                    if (n >= 100) {
                        s += units[Math.floor(n / 100)] + ' ' + bigUnits[1] + ' ';
                        n %= 100;
                    }
                    if (n > 10 && n < 20) {
                        s += tens[1] + units[n % 10];
                    } else if (n >= 10) {
                        s += tens[Math.floor(n / 10)] + ' ' + units[n % 10];
                    } else if (n > 0) {
                        s += units[n];
                    }
                    return s;
                }
                
                let numStr = num.toString().split('.')[0].split('').reverse().join('');
                let words = '';
                let chunkWords = [];
                let chunkValues = [];

                if (num === 0) return 'शून्य';

                for (let i = 0; i < numStr.length; i++) {
                    chunkValues.push(parseInt(numStr[i]));
                    if (i === 1 || i === 3 || i === 5 || i === 7) {
                        const chunk = (chunkValues[i] * 10) + chunkValues[i - 1];
                        chunkWords.push(convertChunk(chunk) + ' ' + bigUnits[(i + 1) / 2]);
                    } else if (i === 0) {
                        if (numStr.length === 1) {
                           chunkWords.push(units[chunkValues[0]]);
                        }
                    }
                }
                
                // Simplified conversion logic for demonstration
                let crore = Math.floor(num / 10000000);
                let lakh = Math.floor((num % 10000000) / 100000);
                let thousand = Math.floor((num % 100000) / 1000);
                let hundred = Math.floor((num % 1000) / 100);
                let remaining = num % 100;

                let nepaliWords = '';
                if (crore > 0) nepaliWords += `${numberToNepaliWords(crore)} करोड `;
                if (lakh > 0) nepaliWords += `${numberToNepaliWords(lakh)} लाख `;
                if (thousand > 0) nepaliWords += `${numberToNepaliWords(thousand)} हजार `;
                if (hundred > 0) nepaliWords += `${units[hundred]} सय `;
                if (remaining > 0) {
                    if (remaining < 20) {
                        if (remaining > 10) {
                            nepaliWords += `${tens[1]} ${units[remaining % 10]} `;
                        } else {
                            nepaliWords += `${units[remaining]} `;
                        }
                    } else {
                        nepaliWords += `${tens[Math.floor(remaining / 10)]} ${units[remaining % 10]} `;
                    }
                }
                
                return nepaliWords.trim();
            }

            // Event listeners for dynamic calculations
            addSourceBtn.addEventListener('click', addIncomeSourceRow);
            conversionRateInput.addEventListener('input', updateAUDTotal);
            // Initial row
            addIncomeSourceRow();

            previewBtn.addEventListener('click', function() {
                const incomeData = [];
                document.querySelectorAll('.income-source-row').forEach(row => {
                    const source = row.querySelector('.source-input').value;
                    const amount = parseFloat(row.querySelector('.amount-input').value) || 0;
                    if (source && amount > 0) {
                        incomeData.push({ source, amount });
                    }
                });

                const totalNPR = parseFloat(totalIncomeInput.value.replace(/,/g, ''));
                const totalAUD = totalInAUDInput.value;
                const totalWords = numberToNepaliWords(totalNPR);

                // Update preview content
                document.getElementById('previewMunicipalityNepali').textContent = document.getElementById('municipalityNepali').value;
                document.getElementById('previewMunicipalityEnglish').textContent = document.getElementById('municipalityEnglish').value;
                document.getElementById('previewWardOfficeNepali').textContent = document.getElementById('wardOfficeNepali').value;
                document.getElementById('previewWardOfficeEnglish').textContent = document.getElementById('wardOfficeEnglish').value;
                document.getElementById('previewDistrictProvinceNepali').textContent = document.getElementById('districtNepali').value + ', ' + document.getElementById('provinceNepali').value;
                document.getElementById('previewDistrictProvinceEnglish').textContent = document.getElementById('districtEnglish').value + ', ' + document.getElementById('provinceEnglish').value;
                document.getElementById('previewRefNo').textContent = 'चलानी नं.: ' + document.getElementById('refNo').value;
                document.getElementById('previewDate').textContent = document.getElementById('date').value;
                document.getElementById('previewApplicantName').textContent = document.getElementById('applicantName').value;
                document.getElementById('previewForWhom').textContent = document.getElementById('forWhom').value;
                document.getElementById('previewPurpose').textContent = document.getElementById('purpose').value;
                document.getElementById('previewTotalIncome').textContent = totalNPR.toLocaleString('ne-NP', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                document.getElementById('previewTotalIncomeWords').textContent = totalWords + ' मात्र';
                document.getElementById('previewTotalInAUD').textContent = totalAUD;
                document.getElementById('previewWardChairpersonName').textContent = document.getElementById('wardChairpersonName').value;

                // Populate the income table
                const incomeTableBody = document.getElementById('incomeTableBody');
                incomeTableBody.innerHTML = '';
                incomeData.forEach((item, index) => {
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${item.source}</td>
                            <td>${item.amount.toLocaleString('ne-NP', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        </tr>
                    `;
                    incomeTableBody.innerHTML += row;
                });

                // Show preview and hide form
                formSection.classList.remove('active');
                previewSection.classList.add('active');
                previewBtn.style.display = 'none';
                backToFormBtn.style.display = 'inline-block';
                printBtn.style.display = 'inline-block';
            });

            backToFormBtn.addEventListener('click', function() {
                // Show form and hide preview
                formSection.classList.add('active');
                previewSection.classList.remove('active');
                previewBtn.style.display = 'inline-block';
                backToFormBtn.style.display = 'none';
                printBtn.style.display = 'none';
            });

            printBtn.addEventListener('click', function() {
                window.print();
            });
        });
    </script>
</body>
</html>

